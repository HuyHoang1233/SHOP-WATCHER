<%@page import="com.khoana.shopwatcher.dao.AccountDAO"%>
<%@page import="com.khoana.shopwatcher.model.Account"%>
<%@ page contentType="text/html; charset=UTF-8" %>
<%
    // 1. Kiểm tra Session trước
    HttpSession session = request.getSession(false);
    Account acc = (session != null) ? (Account) session.getAttribute("account") : null;

    // 2. Nếu Session null, kiểm tra Cookie (Remember Me)
    if (acc == null) {
        Cookie[] cookies = request.getCookies();
        String usernameFromCookie = null;
        if (cookies != null) {
            for (Cookie c : cookies) {
                if ("c_user".equals(c.getName())) {
                    usernameFromCookie = c.getValue();
                    break;
                }
            }
        }

        // Nếu có Cookie, check database để tự động login
        if (usernameFromCookie != null && !usernameFromCookie.isEmpty()) {
            AccountDAO dao = new AccountDAO();
            Account accFromCookie = dao.findByUserName(usernameFromCookie);
            if (accFromCookie != null) {
                // TẠO SESSION MỚI TẠI ĐÂY
                session = request.getSession(true);
                session.setAttribute("account", accFromCookie);
                acc = accFromCookie; // Gán lại biến acc để dùng ở dưới
            }
        }
    }

    // 3. Chốt chặn cuối cùng: Nếu vẫn null thì đuổi về Login
    if (acc == null) {
        response.sendRedirect("Login.jsp"); // Lưu ý tên file Login.jsp viết hoa chữ L như trong ảnh
        return;
    }
%>

<!DOCTYPE html>
<html>
<head>
    <title>Trang Chủ - ShopWatcher</title>
</head>
<body>
    <div align="center">
        <h1>Xin chào, <%= acc.getUsername() %>!</h1>
        <p>Chào mừng bạn quay trở lại ShopWatcher.</p>
        
        <a href="watch.html">Xem Đồng Hồ</a> | 
        <a href="LogoutController">Đăng xuất</a> 
        </div>
</body>
</html>